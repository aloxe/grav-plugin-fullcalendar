{"version":3,"file":"main.js","sources":["src/event-refiners.ts","src/main.ts"],"sourcesContent":["import { createDuration, identity, Identity } from '@fullcalendar/common'\n\ntype RRuleOptions = any // TODO: ask rrule maintainers to expose this\n\nexport const RRULE_EVENT_REFINERS = {\n  rrule: identity as Identity<RRuleOptions>,\n  duration: createDuration\n}\n","import { RRule, rrulestr } from 'rrule'\nimport {\n  RecurringType,\n  EventRefined,\n  DateEnv,\n  DateRange,\n  DateMarker,\n  createPlugin\n} from '@fullcalendar/common'\nimport { RRULE_EVENT_REFINERS } from './event-refiners'\nimport './event-declare'\n\n\nlet recurring: RecurringType<RRule> = {\n\n  parse(refined: EventRefined, dateEnv: DateEnv) {\n\n    if (refined.rrule != null) {\n      let parsed = parseRRule(refined.rrule, dateEnv)\n\n      if (parsed) {\n        return {\n          typeData: parsed.rrule,\n          allDayGuess: parsed.allDayGuess,\n          duration: refined.duration\n        }\n      }\n    }\n\n    return null\n  },\n\n  expand(rrule: RRule, framingRange: DateRange): DateMarker[] {\n    // we WANT an inclusive start and in exclusive end, but the js rrule lib will only do either BOTH\n    // inclusive or BOTH exclusive, which is stupid: https://github.com/jakubroztocil/rrule/issues/84\n    // Workaround: make inclusive, which will generate extra occurences, and then trim.\n    return rrule.between(framingRange.start, framingRange.end, true)\n      .filter(date => date.valueOf() < framingRange.end.valueOf())\n  }\n\n}\n\n\nexport default createPlugin({\n  recurringTypes: [ recurring ],\n  eventRefiners: RRULE_EVENT_REFINERS\n})\n\n\nfunction parseRRule(input, dateEnv: DateEnv) {\n  let allDayGuess = null\n  let rrule\n\n  if (typeof input === 'string') {\n    let preparseData = preparseRRuleStr(input, dateEnv)\n    rrule = rrulestr(preparseData.outStr)\n    allDayGuess = preparseData.isTimeUnspecified\n\n  } else if (typeof input === 'object' && input) { // non-null object\n    let refined = { ...input } // copy\n\n    if (typeof refined.dtstart === 'string') {\n      let dtstartMeta = dateEnv.createMarkerMeta(refined.dtstart)\n\n      if (dtstartMeta) {\n        refined.dtstart = dtstartMeta.marker\n        allDayGuess = dtstartMeta.isTimeUnspecified\n      } else {\n        delete refined.dtstart\n      }\n    }\n\n    if (typeof refined.until === 'string') {\n      refined.until = dateEnv.createMarker(refined.until)\n    }\n\n    if (refined.freq != null) {\n      refined.freq = convertConstant(refined.freq)\n    }\n\n    if (refined.wkst != null) {\n      refined.wkst = convertConstant(refined.wkst)\n    } else {\n      refined.wkst = (dateEnv.weekDow - 1 + 7) % 7 // convert Sunday-first to Monday-first\n    }\n\n    if (refined.byweekday != null) {\n      refined.byweekday = convertConstants(refined.byweekday) // the plural version\n    }\n\n    rrule = new RRule(refined)\n  }\n\n  if (rrule) {\n    return { rrule, allDayGuess }\n  }\n\n  return null\n}\n\n\nfunction preparseRRuleStr(str, dateEnv: DateEnv) {\n  let isTimeUnspecified: boolean | null = null\n\n  function processAndReplace(whole: string, introPart: string, datePart: string) {\n    let res = dateEnv.parse(datePart)\n    if (res) {\n      if (res.isTimeUnspecified) {\n        isTimeUnspecified = true\n      }\n      return introPart + formatRRuleDate(res.marker)\n    } else {\n      return whole\n    }\n  }\n\n  str = str.replace(/\\b(DTSTART:)([^\\n]*)/, processAndReplace)\n  str = str.replace(/\\b(UNTIL=)([^;]*)/, processAndReplace)\n\n  return { outStr: str, isTimeUnspecified }\n}\n\n\nfunction formatRRuleDate(date: DateMarker) { // like '20200101T123030Z'\n  return date.toISOString().replace(/[-:]/g, '').replace('.000', '')\n}\n\n\nfunction convertConstants(input) {\n  if (Array.isArray(input)) {\n    return input.map(convertConstant)\n  }\n  return convertConstant(input)\n}\n\n\nfunction convertConstant(input) {\n  if (typeof input === 'string') {\n    return RRule[input.toUpperCase()]\n  }\n  return input\n}\n"],"names":[],"mappings":"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"}